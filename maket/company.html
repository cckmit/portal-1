<!DOCTYPE html>
<html>
  <head>
    <title>PORTAL / Компания</title>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="pub/theme/style.css">
    <!--script(src='/pub/scripts/jquery-2.1.4.min.js')-->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.4/jquery.js"></script>
    <script>
      /** my lib **/
      function replaceClass(elem, from, to){
          elem.removeClass(from).addClass(to);
          return elem;
      }
      
      function log(){
          console.log(arguments)
      }
      
      function STOP(){
          debugger;
      }
      
      function singleton(){
          if (this.singleton)
              return this.singleton;
          return this.singleton = new (Function.prototype.bind.apply(this, this.args));
      }
      
      function forEach(array, checkAction){
          // делает checkoperation для каждого элемента, если checkOperation возвращает не undefined to forEach возвращает true
          for(var i=0; i<array.length; i++) {
              if(checkAction(i, array[i], array) !== undefined)
                  return true;
          }
      }
      
      
    </script>
    <!--+semanticUI-->
    <script src="pub/scripts/lib/moment.min.js"></script>
    <script src="pub/scripts/lib/jquery.daterangepicker.js"></script>
    <script src="pub/scripts/lib/perfect-scrollbar.jquery.min.js"></script>
    <script src="pub/scripts/jquery-ui.min.js"></script>
    <script src="pub/scripts/lib/scrollFixBlock.js"></script>
    <script src="pub/scripts/lib/jquery.cookie.min.js"></script>


    <link rel="stylesheet" href="pub/theme/lib/daterangepicker.css">
    <link rel="stylesheet" href="pub/theme/lib/perfect-scrollbar.min.css">
    <link rel="stylesheet" href="pub/theme/jquery-ui.min.css">

    <!--+dropdown-->
    <!--+modal-->
    <div id="messaging" class="popup_backgroundBlock simpleMessage">
      <div class="wrapper">
        <div class="popupBlock">
          <div class="textMessage"></div>
        </div>
      </div>
    </div>
    <script>
      function MessageGenerator(){
          var messagePanels = $('#messagePanels');
          //if (!(this instanceof MessageGenerator)) {
          //    if (!MessageGenerator.singleton) {
          //        return MessageGenerator.singleton = new MessageGenerator();
          //    }
          //    else return MessageGenerator.singleton;
          //}
      
          var callQueue = [];
          var openedMessageCount = 0;
      
          function generateMessage(text, type, timer){
              return '<div class="message '+ type +'" onclick="MessageGenerator.get().close($(this))">' +
                      '<div class="body">' +
                      '<span class="icon-mIcon"></span>' +
                      '<span class="text">'+ text +'</span>' +
                      '</div>' +
                      '<div class="rightSide">' +
                      (timer?'<span class="timer">'+ timer +'</span>':'') +
                      '</div>' +
                      '</div>';
          }
      
          this.close = function(elem){
              elem.removeClass('active')
              setTimeout(function(){
                  elem.remove();
              }, 300);
              openedMessageCount--;
      
              if(callQueue.length != 0){
                  var message = callQueue.shift();
                  showMessage(message.text, message.type, message.timer);
              }
          }
      
          function closeMessageAfter(messageElem, timer){
              var timerElem = messageElem.find('.timer');
              var id = setInterval(function(){
                  if(!messageElem){ // пользователь закрыл явно
                      clearInterval(id);
                      return;
                  }
                  if(timer == 0){
                      clearInterval(id);
                      MessageGenerator.singleton.close(messageElem);
                      return;
                  }
                  timerElem.text(timer--);
              }, 1000);
          }
      
          this.show = function(text, type, timer, showAfterMilliSeconds){
              if(openedMessageCount > 100)
                  return; //слишком большая очередь, вероятно произошла циклическая ошибка
              else if(openedMessageCount > 7)
                  callQueue.push({text: text, type: type, timer: timer}); //ставим в очередь
              else
                  showMessage(text, type, timer, showAfterMilliSeconds?showAfterMilliSeconds:100);
              openedMessageCount++;
          }
      
          function showMessage(text, type, timer, showAfterMilliSeconds){
      
              var message = $(generateMessage(text, type, timer));
              messagePanels.prepend(message);
              setTimeout(function () {
                  message.addClass('active');
                  if(timer)
                      closeMessageAfter(message, timer);
              }, showAfterMilliSeconds);
          }
          this.lateCall = function(text, type, timer, showAfterMilliSeconds){
              return this.show.bind(this, text, type, timer, showAfterMilliSeconds);
          }
      }
      MessageGenerator.get = singleton.bind(MessageGenerator)
      
    </script>
  </head>
  <body>
    <div class="global">
      <div class="header_global">
        <div class="leftBlock inactive">
          <div class="company"><span onclick="alert($.eventReport())" class="logo"></span><span class="name">PROTEI</span></div>
          <div id="hideLeftBlock" class="hideBar_button"></div>
        </div>
        <div class="rightBlock">
          <div class="topicTitle employees">
            <div class="title">Новая компания</div>
          </div>
          <!--.currentTask
          span.case Freq
              span.id 7823289
          .timer
              span.time
                  span.hours 01
                  span.timeDelimiter :
                  span.minutes 12
              span#stopCurrentTask.stop_button
          
          -->
          <!--#runTimeFixer.completeWorkSession
          span.icon-time
          |Таймфиксер
          
          -->
          <div class="rightSide">
            <div class="icons">
              <!--#userProfile.userProfilespan.icon-user
              -->
              <!--#globalNotifications.notifications_button.active-->
              <!--#globalSettings.settings_button-->
              <!--#globalHelper.helper_button-->
              <div id="globalExit" class="exit_button"></div>
            </div>
          </div>
          <div class="rightSide searchBlock">
            <form class="globalSearch">
              <input id="globalSearch" placeholder="Поиск по объектам" type="text" autocomplete="off" class="searchInput">
              <!--#p4.searchInput(contenteditable="true")
              span 11
              span 22
                  span 33
              -->
              <div class="buttonsBlock">
                <label class="search_button">
                  <input type="submit" value="Поиск">
                </label>
                <!--label.icon-resetButton
                input(type="reset" value="Сброс")
                
                -->
              </div>
            </form>
          </div>
        </div>
      </div>
      <div class="body_global">
        <div class="leftBlock inactive">
          <div class="noScrolling">
            <div class="scrolling">
              <div class="mainButtons"></div>
              <div class="menuList">
                <div class="menu">
                  <div class="title">Рабочее место</div>
                  <div class="list">
                    <div class="item"><span class="icon-plan"></span>Мой план</div>
                    <div class="item"><span class="icon-created"></span>Инспектор</div>
                    <div class="item"><span class="icon-activity"></span>Моя активность</div>
                    <div class="item"><span class="icon-subscription"></span>Мои подписки</div>
                    <div class="item"><span class="icon-favorites"></span>Мои избранные</div>
                  </div>
                </div>
                <div class="menu">
                  <div class="title">Компания</div>
                  <div class="list">
                    <div class="item"><span class="icon-employees"></span>Сотрудники</div>
                    <div class="item"><span class="icon-me"></span>Мой паспорт</div>
                  </div>
                </div>
                <div class="menu">
                  <div class="title">
                    <!--span.icon-savedQueries-->Объекты системы
                  </div>
                  <div style="max-height: 500px" class="list active">
                    <!--.slideWrapper-->
                    <div class="item"><span class="icon-component"></span>Компоненты</div>
                    <div class="item"><span class="icon-product"></span>Продукты</div>
                    <div class="item"><span class="icon-case"></span>Задачи</div>
                    <div class="item"><span class="icon-order"></span>Группы задач</div>
                    <div class="item"><span class="icon-order"></span>Заказы</div>
                    <div class="item"><span class="icon-project"></span>Проекты</div>
                    <div class="item"><span class="icon-organization"></span>Организации</div>
                  </div>
                </div>
                <div class="menu">
                  <div class="title">
                    <!--span.icon-savedQueries-->Управление и отчёты
                  </div>
                  <div class="list">
                    <!--.slideWrapper-->
                    <div class="item"><span class="icon-employees"></span>Сотрудники</div>
                    <div class="item"><span class="icon-component"></span>Компоненты</div>
                    <div class="item"><span class="icon-product"></span>Продукты</div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <script>
            $('#hideLeftBlock').click(function(){
                $('.header_global >.leftBlock,.body_global >.leftBlock').addClass('inactive');
            })
            $('.body_global >.leftBlock').click(function func(){
                $('.header_global >.leftBlock,.body_global >.leftBlock').removeClass('inactive');
                //$('.body_global >.leftBlock').off()
            })
            
            
          </script>
        </div>
        <div class="rightBlock">
          <script>
            function getTwoDigitNumber(number) {
                return number < 10 ? '0' + number : number;
            }
            var AJAX = new function () {
                this.getEmployee = function (data, success) {
                    return $.get('/api/gate/employees/' + data + '.json', null, success, 'json');
                }
                this.getMissingEmployees = function (success) {
                    return $.get('/api/gate/currentMissingEmployees.json', null, success, 'json');
                }
                this.getEmployeeAbsences = function (data, success) {
                    return $.get('/api/gate/employees/' + data.id + '/absences.json?full=' + data.isFull + '&from=' + data.from + '&till=' + data.till, null, success, 'json');
                }
                this.getEmployeeAbsence = function (data, success) {
                    return $.get('/api/gate/employees/' + data.userId + '/absences.json?id=' + data.absenceId, null, success, 'json');
                }
                this.saveEmployeeAbsence = function (data, success) {
                    return $.post('/api/gate/saveAbsence', data, success, 'text');
                }
                this.deleteAbsence = function (data, success) {
                    return $.get('/api/gate/deleteAbsence?id=' + data, null, success, 'text');
                }
            };
            function ActionSequence() { //последовательность действий при ajax запросе
                var completed;
                var actions = [];
                var ajaxData;
                this.then = function (func) {
                    if (completed) // если ajax success ф-я закончена, то просто вызываем переданное действие
                        func(ajaxData);
                    else actions.push(func) // иначе помещаем в массив
                    return this;
                }
                this.run = function (data) { // доп String textStatus, jqXHR jqXHR
                    while (actions.length != 0) {
                        actions.shift()(data); // выполняем следующее действие и удаляем его
                    }
                    ajaxData = data;
                    completed = true;
                }
            }
            Date.prototype.getWeekNumber = function () {
                var d = new Date(this.getTime());
                d.setHours(0, 0, 0);
                d.setDate(d.getDate() + 4 - (d.getDay() || 7));
                var yearStart = new Date(d.getFullYear(), 0, 1);
                return Math.ceil(( ( (d - yearStart) / 86400000) + 1) / 7);
            }
            Date.prototype.getCorrectedDay = function () {
                var d = this.getDay() - 1;
                return d == -1 ? 6 : d;
            }
            Date.prototype.getUTCTime = function () {
                return this.getTime() - this.getTimezoneOffset() * 60000;
            }
            Date.daysInMonth = function daysInMonth(year, month) {
                return new Date(year, month + 1, 0).getDate();
            }
            Date.prototype.daysInMonth = function daysInMonth() {
                return new Date(this.getFullYear(), this.getMonth() + 1, 0).getDate();
            }
            String.escapeSymbols = {
                "&": "&amp;",
                "<": "&lt;",
                ">": "&gt;",
                '"': '&quot;',
                "'": '&#39;',
                "/": '&#x2F;'
            };
            String.prototype.escapeHTML = function () {
                return this.replace(/[&<>"'\/]/g, function (s) {
                    return String.escapeSymbols[s];
                }).replace(/\s+/gm, " ");
            }
            var ABSENCE_REASONS = ["Командировка", "Отпуск", "Болезнь", "Личные дела", "Местная командировка", "Учеба", "Больничный лист", "Гостевой пропуск", "Ночные работы", "Отпуск за свой счёт", "Расписание"];
            var MONTHS = ['Январь', 'Февраль', 'Март', 'Апрель', 'Май', 'Июнь', 'Июль', 'Август', 'Сентябрь', 'Октябрь', 'Ноябрь', 'Декабрь'];
            var DAYS = ['Вс', 'Пн', 'Вт', 'Ср', 'Чт', 'Пт', 'Сб'];
            function timeToString(date) {
                return getTwoDigitNumber(date.getHours()) + ':' + getTwoDigitNumber(date.getMinutes())
            }
            function dateToString(date) {
                return getTwoDigitNumber(date.getDate()) + '.' + getTwoDigitNumber(date.getMonth()) + '.' + (date.getFullYear() - 2000);
            }
            
          </script><script>/**
 * require:
 * selectList
 *
 */


function InputSelectList(options) {
    SelectList.call(this, options);
    var self = this;
    var inputField = options.selector;

    inputField.focus(function(event){
        if(!self.isOpen()){
            self.open(event);
        }
    });
    //inputField.next().focus(function(){
    //    if(self.isOpen()){
    //        self.close();
    //    }
    //});
    //inputField.on('focusout', function(event){
    //    if(self.isOpen()){
    //        $(event.target).trigger('click', event)
    //        self.close(event);
    //    }
    //});

    var dataList = options.dataList || options.getDataList();
    $(inputField).on('input', function () {
        var inputText = inputField.val().toLowerCase();
        var newDl = {};

        for(var key in dataList) {
            if (dataList[key].toLowerCase().indexOf(inputText) == 0)
                newDl[key] = dataList[key];
        }

        if($.isEmptyObject(newDl))
            return self.close();

        self.generateSelectList(newDl);

        if(!self.isOpen())
            self.open();
    });
}</script><script>/**
 * require:
 * bindDocumentKillingClick2
 *
*/

function SelectList(options){
    var self = this;

    var selector = options.selector;
    var outerSelector = options.outerSelector;

    var changeAction = options.changeAction || $.noop;
    var closeAction = options.closeAction || $.noop;
    var openAction = options.openAction || $.noop;

    var dataList = options.dataList||options.getDataList();
    var slLength = options.maxLength || 11;

    var hi; //hover index
    var items;
    var activeIndex;
    var initialIndex;
    var visibleItemsIndex;
    var slwHeight; //selectListWrapHeight
    var slHeight;
    var cellHeight = 29;
    var isGenerated;

    var selectList = $('<div class="selectList"></div>');
    var selectListWrap = $('<div class="wrapper"></div>');
    selectList.append(selectListWrap);
    outerSelector.append(selectList);

    this.getSelectList = function(){
        return selectList;
    };

    this.generateSelectList = function(dl){
        var html = '';
        var i = 0;
        dataList = dl;
        activeIndex = hi = initialIndex = i;
        visibleItemsIndex = [];
        for(var val in dataList){
            var activeItem = '';
            if(typeof dataList[val] == 'object') {
                if (dataList[val].initial) {
                    activeIndex = hi = initialIndex = i;
                    activeItem = ' active hover';
                }
                dataList[val].toString = function(){
                    return dataList[val].val;
                }
            }
            html += '<div class="item show'+ activeItem +'" data-index="'+ i +'" data-val="'+ val +'">'+ dataList[val] +'</div>';
            visibleItemsIndex[i] = i;
            i++;
        }
        selectListWrap.html(html);
        items = selectListWrap.find('.item');

        if(items.filter('.hover').length ==0){
            items.eq(0).addClass('hover');
        }
        if(items.length > slLength)
            selectList.addClass('moreBottom');

        slHeight = slLength * cellHeight;
        selectList.css('max-height', slLength * cellHeight);
    };

    function mouseMover(event){
        goToNextItem(event.target.getAttribute("data-index"));
    }


    function goToNextItem (newHoverIndex){
        items.eq(visibleItemsIndex[hi]).removeClass('hover');
        hi = newHoverIndex;
        return items.eq(visibleItemsIndex[hi]).addClass('hover');
    }

    this.getActiveIndex = function() {
        return items.eq(activateIndex).attr('data-val');
    };

    this.setActiveIndex = function(key) {
        var index = items.filter('[data-val="'+ key +'"]').attr('data-index');
        goToNextItem(index);
        activateIndex(index);
    };

    this.reset = function(){
        this.goToNextItem(initialIndex);
        select(initialIndex);
    };

    function onWheel (event){
        var offset = parseInt(selectListWrap.css('margin-top')) + (cellHeight * (event.originalEvent.deltaY > 0 ? -1 : 1));

        if(offset >= slHeight - slwHeight){
            if(offset>0)
                offset = 0;

            if (offset < 0)
                selectList.addClass('moreTop');
            else
                selectList.removeClass('moreTop');

            if (Math.abs(offset) + 1 + slHeight >= slwHeight)
                selectList.removeClass('moreBottom');
            else
                selectList.addClass('moreBottom');

            selectListWrap.css('margin-top', offset);
        }
        event.preventDefault();
    }

    function select (hi) {
        STOP();
        changeAction.call(options, items[hi].getAttribute('data-val'), items[hi].textContent);
        if(selector.is('input'))
            selector.val(items[hi].textContent);
        else
            selector.text(items[hi].textContent);
        activateIndex(hi);
    }

    function activateIndex (hi) {
        items.eq(activeIndex).removeClass('active');
        activeIndex = hi;
        items.eq(hi).addClass('active');
    }

    this.listToCenter = function() { // активную ячейку старается сделать в центре
        //if(!activeIndex || this.slHeight == this.slwHeight)
        //    return;
        STOP();

        var requiredOffset = Math.ceil(slLength / 2) * cellHeight - cellHeight;
        var topOffset = items.eq(activeIndex).position().top;
        var marginTop = parseInt(selectListWrap.css('margin-top'));

        marginTop -= topOffset - requiredOffset + 1;

        if(marginTop > 0)
            marginTop = 0;
        else if(Math.abs(marginTop) > slwHeight - slHeight)
            marginTop = -(slwHeight - slHeight);

        selectListWrap.css('margin-top', marginTop);

        calcLimitBorders(marginTop);
    };


    function calcLimitBorders(marginTop){
        if (marginTop < 0) selectList.addClass('moreTop');
        else selectList.removeClass('moreTop');

        if (Math.abs(marginTop) + slHeight < slwHeight) selectList.addClass('moreBottom');
        else selectList.removeClass('moreBottom');
    }


    function keyDownTracking(event){
        var elemOffset;
        var marginTop;
        var centerOffset = Math.ceil(slLength / 2) * cellHeight - 1; // высота от первой до центральной ячейки в px
        var _hi = hi;

        switch (event.which) {
            case 13: // enter

                select(_hi);
                self.close();
                break;

            case 38: // up

                if (_hi != 0) {
                    marginTop = parseInt(selectListWrap.css('margin-top'));

                    elemOffset = goToNextItem(--_hi).position();
                    if (marginTop != 0 && elemOffset.top + cellHeight < centerOffset)
                        selectListWrap.css('margin-top', marginTop += cellHeight);


                    if(dataList.length > slLength)
                        calcLimitBorders(marginTop);

                }
                break;
            case 40: // down

                if(_hi<visibleItemsIndex.length-1){
                    marginTop = parseInt( selectListWrap.css('margin-top') );

                    elemOffset = goToNextItem(++_hi).position();
                    if(elemOffset.top >= centerOffset && slwHeight + marginTop - slHeight > 0){
                        selectListWrap.css('margin-top', marginTop -= cellHeight);
                    }

                    if(dataList.length > slLength)
                        calcLimitBorders(marginTop);
                }

                break;
            default:
                return; // exit this handler for other keys
        }
        event.preventDefault();
    }


    function documentClick(event){
        var elem = event.target;
        if(selector.is(elem))
            return;
        if(selectList.has(elem).length > 0)
            select(elem.getAttribute('data-index'));
        self.close(event);
    }

    this.destroy = function(){
        selector.off('click')
    };

    this.isOpen = function(){
      return selectList.hasClass('active');
    };

    this.open = function(event){
        if(selectList.hasClass('active'))
            return self.close(event);

        selectList.addClass('active');
        if(!isGenerated){
            self.generateSelectList(dataList);
            isGenerated = true;
        }

        slwHeight = selectListWrap.height() + 1;
        $(document).keydown(keyDownTracking);
        $(document).click(documentClick);
        selectListWrap.on('mousemove', mouseMover);
        if(items.length > slLength)
            selectList.on('wheel', onWheel);

        openAction.call(options, event);
        if(dataList.length > slLength)
            this.listToCenter();
    };

    this.close = function(event){
        $(document).off('keydown', keyDownTracking);
        $(document).off('click', documentClick);
        selectList.off('wheel');
        selectListWrap.off('mousemove');
        selectList.removeClass('active');

        closeAction.call(options, event);
    };

    //if(!this.init){
    //this.init = function(){
    selector.on('click', function(event){
        if(!self.isOpen()){
            event.stopPropagation();
            self.open(event);
        }
    });
    //};
    //}

    //this.init();


    //function positionSelectObject(){ // центрироввание и установка ширины
    //    //selectObject.css('min-width', selector.outerWidth()).css('margin-top', 2)
    //    //popupToCenter(selectObject, selector);
    //}

}






















</script>
          <script>
            function _CompanyConstruction(){
                var self = this;
            
                this._init = function(modal) {
                    var sel = modal.find('input.selected');
            
                    var selectList = new InputSelectList({
                        selector: sel,
                        outerSelector: sel.parent(),
                        openAction: function () {
                            selectList.getSelectList().css('min-width', this.selector.outerWidth()).css('margin-top', 2)
                        },
                        dataList: {
                            "1": "Мегафон",
                            "2": "Ростелеком",
                            "3": "Симтелеком",
                            "4": "МТС"
                        }
                    });
            
                    modal.find('.add_button').on('click', self.addNewField);
                }
            
                this.getField = function() {
                    var html =
                            '<div class="field">' +
                                '<input type="text" class="inputField val">' +
                                '<input type="text" class="inputField comment" placeholder="Комментарий">' +
                                '<button class="button greenC empty add_button"></button>' +
                            '</div>';
                    $(html).find('.add_button').on('click', self.addNewField);
                    return html
                }
            
                this.addNewField = function(event) {
                    var elem = $(event.currentTarget);
                    if (elem.hasClass('add_button')) {
                        elem.removeClass('add_button greenC').addClass('delete_button redC');
                        var f = $(self.getField());
                        f.find('.add_button').on('click', self.addNewField);
                        elem.parent().before(f);
                    }
                    else {
                        elem.parent().remove()
                    }
                }
            }
            
            
            function CompanyModalWindow() {
                _CompanyConstruction.call(this);
            
                var modal;
                this.close = function (event) {
                    modal.removeClass('active');
                    setTimeout(function () {
                        modal.remove();
                    }, 300);
                }
            
                this.generateModalWindow = function (company) {
                    var html =
                        '<div class="popup_backgroundBlock">' +
                            '<div class="wrapper">' +
                                '<div class="popupBlock">' +
                                    '<div class="popup companyConstruction active">' +
                                        '<div class="head">' +
                                            '<span class="part name">'+ (company?'Компания #'+ company.id:'Новая компания') +'</span>' +
                                            '<div class="rightSide">' +
                                                '<div class="close_button"></div>' +
                                            '</div>' +
                                        '</div>' +
                                        '<div class="body">' +
                                            '<div class="grid">' +
                                                '<div class="row">' +
                                                    '<div class="col title">Название компании<span class="required">*</span></div>' +
                                                    '<div class="col max">' +
                                                        '<input type = "text" class="inputField">' +
                                                    '</div>' +
                                                '</div>' +
                                                '<div class="row">' +
                                                    '<div class="col title">Группа компаний</div>' +
                                                    '<div class="col">' +
                                                        '<div class="field">' +
                                                            '<div class="button selected whiteC">Нет</div>' +
                                                            '<div class="button greenC">Создать</div>' +
                                                        '</div>' +
                                                    '</div>' +
                                                '</div>' +
                                                '<div class="row">' +
                                                    '<div class="col title">Фактический адрес<span class="required">*</span></div>' +
                                                    '<div class="col">' +
                                                        '<input type = "text" class="inputField">' +
                                                    '</div>' +
                                                '</div>' +
                                                '<div class="row">' +
                                                    '<div class="col title">Юридический адрес<span class="required">*</span></div>' +
                                                    '<div class="col max">' +
                                                        '<input type = "text" class="inputField">' +
                                                    '</div>' +
                                                '</div>' +
                                                '<div class="row">' +
                                                    '<div class="col title">Web сайт</div>' +
                                                    '<div class="col max">' +
                                                        '<div class="field">' +
                                                            '<span class="label">http://</span><input type="text" class="inputField">' +
                                                        '</div>' +
                                                    '</div>' +
                                                '</div>' +
                                                '<div class="row">' +
                                                    '<div class="col title">Телефон</div>' +
                                                    '<div class="col max">' +
                                                        this.getField() +
                                                    '</div>' +
                                                '</div>' +
                                                '<div class="row">' +
                                                    '<div class="col title">Email</div>' +
                                                    '<div class="col max">' +
                                                        this.getField() +
                                                    '</div>' +
                                                '</div>' +
                                                '<div class="row">' +
                                                    '<div class="col title">Комментарий</div>' +
                                                    '<div class="col max">' +
                                                        '<div class="ui form field">' +
                                                            '<textarea class="text inputField"></textarea>' +
                                                        '</div>' +
                                                    '</div>' +
                                                '</div>' +
                                                '<div class="row">' +
                                                    '<div class="col title">Контактные лица</div>' +
                                                    '<div class="col max">' +
                                                        '<div class="button greenC max">Создать</div>' +
                                                    '</div>' +
                                                '</div>' +
                                            '</div>' +
                                        '</div>' +
                                        '<div class="footer">' +
                                            '<div class="button greenC">Сохранить</div>' +
                                            '<div class="button grayC close_button">Отмена</div>' +
                                        '</div>' +
                                    '</div>' +
                                '</div>' +
                            '</div>' +
                        '</div>';
            
                    return $(html);
                }
            
                this.init = function(){
                    modal = this.generateModalWindow();
                    $(document.body).append(modal);
                    modal.show();
            
                    modal.find('.close_button').one('click', this.close);
            
                    setTimeout(function () {
                        modal.addClass('active')
                    }, 100);
            
                    this._init(modal);
                }
            }
            
            function CompanyWindow(){
                _CompanyConstruction.call(this);
                this.init = function(){
                    this._init($('#companyConstruct'));
                }
            }
            
            
            
          </script>
          <div id="companyConstruct" class="CompanyConstruction">
            <div class="body">
              <div class="grid">
                <div class="row">
                  <div class="col">
                    <div class="title">Название компании<span class="required">*</span></div>
                    <div class="field verifiable">
                      <input type="text" class="inputField">
                    </div>
                  </div>
                  <div class="col">
                    <div class="title">Группа компаний</div>
                    <div class="field">
                      <div class="field selected">
                        <input type="text" class="inputField button selected whiteC">
                      </div>
                      <button class="button greenC">Создать</button>
                    </div>
                  </div>
                </div>
                <div class="row">
                  <div class="col">
                    <div class="title">Фактический адрес<span class="required">*</span></div>
                    <div class="field">
                      <textarea class="text inputField"></textarea>
                    </div>
                  </div>
                  <div class="col">
                    <div class="title">Юридический адрес<span class="required">*</span></div>
                    <div class="field">
                      <textarea class="text inputField"></textarea>
                    </div>
                  </div>
                </div>
                <div class="row">
                  <div class="title">Web сайт</div>
                  <div class="field"><span class="label">http://</span>
                    <input type="text" class="inputField">
                  </div>
                </div>
                <div class="row">
                  <div class="col">
                    <div class="title">Телефон</div>
                    <div class="field">
                      <input type="text" class="inputField val">
                      <input type="text" placeholder="Комментарий" class="inputField comment">
                      <button class="button greenC empty add_button"></button>
                    </div>
                  </div>
                  <div class="col">
                    <div class="title">Email</div>
                    <div class="field">
                      <input type="text" class="inputField val email">
                      <input type="text" placeholder="Комментарий" class="inputField comment">
                      <button class="button greenC empty add_button"></button>
                    </div>
                  </div>
                </div>
                <div class="row">
                  <div class="title">Комментарий</div>
                  <div class="field">
                    <textarea class="text inputField"></textarea>
                  </div>
                </div>
                <div class="row">
                  <div class="title bordered">Контактные лица</div>
                  <div class="field">
                    <!--.button.greenC.max Создать-->
                  </div>
                </div>
              </div>
            </div>
            <div class="footer">
              <button class="button greenC">Сохранить</button>
              <button class="button whiteC close_button">Отмена</button>
            </div>
            <!--.controlButtons
            .rightSide
                .button.greenC(onclick="new CompanyModalWindow().show()") Добавить компанию
            
            
            
            -->
          </div>
        </div>
      </div>
      <script>
        function setPopupPosition(event, popup, innerOffset, outerTopOffset) {
            popup.css('left', '');// для правильного вычисления ширины
            var width = popup.outerWidth();
            if (width < innerOffset)
                popup.css('left', event.clientX - width / 2).removeClass('toLeft toRight').addClass('toCenter');
            else if (event.clientX + width > $(document).width())
                popup.css('left', event.clientX - width + innerOffset).removeClass('toLeft toCenter').addClass('toRight');
            else
                popup.css('left', event.clientX - innerOffset).removeClass('toRight toCenter').addClass('toLeft');
            popup.css('top', $(event.currentTarget).offset().top + outerTopOffset);
        }
        function bindDocumentKillingClick2(closeAction) {
            var freeElems = arguments; // элементы, клики на которых будут игнорироваться
            var eventAction;
        
            function off() {
                document.body.removeEventListener('mousedown', eventAction, true);
            }
        
            document.body.addEventListener('mousedown', eventAction = function (event) {
                var elem = event.target;
                for (var i = 1; i < freeElems.length; i++) {
                    if ($(freeElems[i]).has(elem).length > 0)
                        return;
                }
                if (closeAction(event))
                    off();
            }, true);
            return {
                off: off
            };
        }
        function showAbsenceInfo(event, id, timeFrom, timeTill, absenceId, comment) {
            //var elem = $(event.currentTarget);
            diagramProducer.showAbsenceInfoPopup(event, id, timeFrom, timeTill, absenceId, comment);
        }
        
      </script><script>/**
 * require:
 * MONTHS[]
 * MessageGenerator
 * AJAX
 * timeToString()
 * dateToString()
 * getTwoDigitNumber()
 * ABSENCE_REASONS[]
 * getBlockWidth()
 * SelectList
**/


function AbsenceViewer(){
    var absenceViewer = $('#absenceViewer');
    var name;
    var userId;
    var closeAfterDeferred;
    var windowQueue = [];
    var loadedAbsences = new function(){
        this.from = 0;
        this.till = 0;
        var self = this;
        this.absences = [];
        this.remove = function(absenceId){
            for(var i = 0; i < this.absences.length; i++)
                if(this.absences[i].id == absenceId){
                    this.absences.splice(i, 1);
                    break;
                }
        };
        this.download = function(from, till, successAction){
            from = new Date(+from);
            from.setHours(0,0);
            till = new Date(+till);
            till.setHours(23,59);
            AJAX.getEmployeeAbsences(
                    {
                        id: userId,
                        from: +from,
                        till: +till,
                        isFull: true
                    },
                    function(data){
                        self.absences = data.absences||[];
                        successAction(self.absences)
                    }
            ).fail(MessageGenerator.get().lateCall("Ошибка! Не удалось подгрузить отсутствия", "error", 6));
        };
        this.downloadSingle = function(absenceId, successAction){
            AJAX.getEmployeeAbsence(
                {
                    userId: userId,
                    absenceId: absenceId
                },
                function(data){
                    self.absences.push(data.absence); //& ?????????????????????????
                    successAction(data.absence)
                }
            ).fail(MessageGenerator.get().lateCall("Ошибка! Не удалось подгрузить отсутствия", "error", 6));
        };

        this.findId = function(id, successHandler){
            for(var i = 0; i < this.absences.length; i++){
                if (this.absences[i].id == id) {
                    successHandler(i, this.absences[i]);
                    break;
                }
            }
        };
        this.getById = function(id, downloadIfNotExists){
            var absence = null;
            this.findId(id, function(i, e){absence = e});

            if(!absence && downloadIfNotExists)
                this.downloadSingle(id, function(a){
                    absence = a;
                });

            return absence;
        }
    };
    var changes;
    var userData;

    //function UserData(){
    //    this.absenceSection;
    //    this.absencesSection;
    //    this.absenceEditorSection;
    //}

    this.showSection = function(number){
        var currentSection = windowQueue.pop();
        currentSection.section.close(300);
        currentSection.url.revert();
        for(var i = windowQueue.length - 1; i>=0; i--){ // Удаляем предыдущие
            if(i>number){
                windowQueue.pop().url.revert();
            }
        }
        setTimeout(function(){
            var selectedSection = windowQueue[windowQueue.length - 1];
            var sectionData = userData[currentSection.sectionName];
            if(currentSection.changed){
                selectedSection.section.redraw(sectionData);
                selectedSection.changed = true; // для вышестоящих окон
            }
            selectedSection.section.reshow(100, sectionData);
        }, 300);
    };


    function _Section(section, sectionName){

        this.reshow = function (afterTime, prevSectionData) {
            if (!userData[sectionName]) {
                return this.show(prevSectionData);
            }
            afterTime = afterTime||0;
            setTimeout(function () {
                section.show();
                setTimeout(function () {
                    section.addClass('active');
                }, 100);
            }, afterTime);
        };

        this.close = function(afterTime){
            afterTime = afterTime||0;
            section.removeClass('active');
            setTimeout(function(){
                section.hide();
            }, afterTime);
        };

        this._pushInQueue = function(titleName, urlReplacer){
            for(var i=0; i<windowQueue.length; i++)
                if(windowQueue[i].section == this) // если уже есть в стеке, тогда выходим
                    return;

            windowQueue.push({
                section: this,
                name: titleName,
                url: urlReplacer,
                sectionName: section
            })
        };

        this.buildParentsToolBar = function(){
            var parentSections = section.children('.parentSections');
            if(windowQueue.length > 0) {
                var currentSection = windowQueue[windowQueue.length - 1];
                currentSection.section.close(300);
                var html = '';
                for (var i = 0; i < windowQueue.length; i++) {
                    html += '<div class="parentSection" onclick="AbsenceViewer.get().showSection(' + i + ')">' + windowQueue[i].name + '</div>';
                }
                parentSections.html(html).show();
            }else
                parentSections.hide();
        };

        this._deleteAbsence = function(absenceId){
            var errorF = MessageGenerator.get().lateCall('Ошибка! Отсутствие не было удалено. Обновите страницу и попробуйте ещё раз', 'error');
            var defer = $.Deferred();

            ConfirmGenerator.get().show('Вы уверены что хотите удалить отсутствие?', 'warning', 'Удалить', function(){
                AJAX.deleteAbsence(absenceId, function(data){
                    if(data){
                        loadedAbsences.findId(absenceId, function(i){
                            loadedAbsences.absences.splice(i, 1);
                        });
                        changes[absenceId] = {
                            type: 'deleted',
                            absence: null
                        };
                        MessageGenerator.get().show('Отсутствие удалено!', 'success', 4);
                        defer.resolve();
                    }
                    else
                        errorF();
                }).fail(errorF)
            });

            return defer;
        }
    }
    function _Schedulable(sectionName){

        this.changeWeek = function(event){}

        this.generateScheduleBlock = function(schedule, weekNumber){
            var html =
                '<div class="dimension_wrapper'+ (weekNumber == 1?' oneWeek_showing':'') +'">'+
                    '<div class="schedule">'+
                        '<div class="head">Расписание'+
                            '<div class="rightSide">'+
                                '<div class="weekParity_button" data-weekNumber="'+ weekNumber +'" onclick="AbsenceViewer.get().'+ sectionName +'().changeWeek(event)">'+ weekNumber +'нед.</div>'+
                            '</div>'+
                        '</div>'+
                        '<div class="body">'+
                            '<table>' +
                                '<thead>'+
                                    '<tr class="headers">'+
                                        '<td class="day"></td>'+
                                        '<td class="week">'+ (weekNumber==2?'Чётная неделя':'Чётная и нечётная недели') +'</td>'+
                                        '<td class="week">Нечётная неделя</td>'+
                                    '</tr>'+
                                '</thead>'+
                                '<tbody>'+
                                    generateWeeks(schedule)+
                                '</tbody>'+
                            '</table>' +
                        '</div>'+
                    '</div>'+
                '</div>';
            return html;
        };

        function generateDay(week, i){
            var html;
            if(week[DAYS[i + 1]]){
                var parts = week[DAYS[i + 1]].split('-');
                html =
                    '<span class="time">' +
                        '<span class="from'+ (parts[0]=='00:00'?' timeLimit">':'">'+ parts[0]) +'</span>' +
                        '—' +
                        '<span class="to'+ (parts[1]=='23:59'?' timeLimit">':'">'+ parts[1]) +'</span>' +
                    '</span>' +
                    '<span class="delete_button" onclick="AbsenceViewer.get().absenceEditorSection().deleteDay(event, '+ i +')"></span>';
            }else
                html = '<div class="time newTime_button"></div>';

            return html;
        }

        function generateWeeks(schedule){
            var commonWeek = schedule['чёт']||schedule
            var html = '';
            for(var i = 0; i < 5; i++)
                html +=
                    '<tr>'+
                        '<td class="day">'+ DAYS[i + 1] +'</td>'+
                        '<td class="week" data-parity="чёт" data-day="'+ i +'">' +
                            generateDay(commonWeek, i)+
                        '</td>'+
                        '<td class="week" data-parity="нечёт" data-day="'+ i +'">'+
                            (schedule['нечёт']?generateDay(schedule['нечёт'], i):'<div class="time newTime_button"></div>') +
                        '</td>'+
                    '</tr>';
            return html
        }
    }


    function AbsenceSection(){
        var section = absenceViewer.children('.wrapper').children('.popupBlock').children('.absence');
        var self = this;
        var sectionName = 'absenceSection';

        _Section.call(this, section, sectionName);
        _Schedulable.call(this, sectionName);

        this.show = function(data){
            if(typeof data == "number")
                data = loadedAbsences.getById(data);
            else if(data.absenceId){
                data = loadedAbsences.getById(data.absenceId);
            }

            showAbsence(data);
        };

        this.pushInQueue = function(id){
            this._pushInQueue('Отсутствие #'+ id, new UrlReplacer('/user'+ userId +'/absence'+ id));
        };

        this.redraw = function (prevData) {
            if (!userData[sectionName])
                return this.show(prevData.absenceId);
            correctAbsenceSection(loadedAbsences.getById(prevData.absenceId));
        };

        function correctAbsenceSection(absence){
            var dateFrom = new Date(+absence.dateFrom);
            var dateTill = new Date(+absence.dateTill);

            section.find('.from .date').text(dateToString(dateFrom));
            var time = getTwoDigitNumber(dateFrom.getHours()) +':'+ getTwoDigitNumber(dateFrom.getMinutes());
            section.find('.from .time').text(time=='00:00'?'с начала дня':time);

            section.find('.to .date').text(dateToString(dateTill));
            time = getTwoDigitNumber(dateTill.getHours()) +':'+ getTwoDigitNumber(dateTill.getMinutes());
            section.find('.to .time').text(time=='23:59'?'до конца дня':time);

            section.find('.absenceReason_button').text(ABSENCE_REASONS[absence.reason - 1])[0].className = 'absenceReason_button reason'+ absence.reason;
            section.find('.comment .text').text(absence.comment);

            var scheduleBlock = section.find('.tc_wrapper.scheduleBlock');
            if(absence.reason == 11) { //расписание

                var schedule = JSON.parse(absence.schedule);
                var weekNumber = schedule['чёт'] || schedule['нечёт']?2:1;
                scheduleBlock.addClass('active').html($(self.generateScheduleBlock(schedule, weekNumber)));

                if(weekNumber == 2) scheduleBlock.removeClass('oneWeek_showing');
                else scheduleBlock.addClass('oneWeek_showing');

                section.addClass('schedule_showing');
            }else{
                scheduleBlock.removeClass('active').html('');
                section.removeClass('schedule_showing');
            }
        }

        function showAbsence(absence){
            //var sectionName = 'Отсутствие #'+ absence.id;

            self.buildParentsToolBar();
            self.pushInQueue(absence.id);

            section.find('.name').text(name);
            section.find('.absenceId').text('Отсутствие #'+ absence.id);

            section.find('.edit_button')[0].onclick = function(){
                AbsenceViewer.get().absenceEditorSection().edit(absence.id)
            };
            section.find('.delete_button')[0].onclick = function(){
                self._deleteAbsence(absence.id).done(function(){
                    windowQueue[windowQueue.length - 1].changed = true;
                    AbsenceViewer.get().showSection(0)
                });
            };
            section.find('.duplicate_button')[0].onclick = function(){
                AbsenceViewer.get().absenceEditorSection().duplicate(absence.id);
            };

            correctAbsenceSection(absence);

            userData[sectionName] = {absenceId: absence.id};
            self.reshow(300);
        }

    }
    this.absenceSection = singleton.bind(AbsenceSection);


    function AbsencesSection() {
        var section = absenceViewer.find('.absenceViewer:first');
        var dateNow;

        var absenceReasonFilter = new SelectList({
            selector: $('#absenceReasonFilter'),
            outerSelector: $('#absenceReasonFilter').parent(),
            changeAction: function(key, val){
                filterBy(key, val);
                this.selector.text(val);
            },
            openAction: function(){
                absenceReasonFilter.getSelectList().css('min-width', this.selector.outerWidth()).css('margin-top', 2)
            },
            dataList: {
                "0":{
                    val: "Все типы отсутствий",
                    initial: true
                },
                "3":"Болезнь",
                "7":"Больничный лист",
                "8":"Гостевой пропуск",
                "1":"Командировка",
                "4":"Личные дела",
                "5":"Местная командировка",
                "9":"Ночные работы",
                "2":"Отпуск",
                "10":"Отпуск за свой счёт",
                "11":"Расписание",
                "6":"Учёба",
            }
        });
        var sectionName = 'absencesSection';

        var absenceList = section.find('.AbsenceList');
        var absenceListTbody = absenceList.find('tbody');
        var emptyBlock = absenceList.next('.EmptyBlock');
        var dateTime;
        var self = this;

        _Section.call(this, section, sectionName);

        this.deleteAbsence = function(absenceId){
            this._deleteAbsence(absenceId).done(function(){
                generateAbsences(loadedAbsences.absences);
            })
        };

        this.redraw = function () {
            if (!userData.absencesSection) {
                return this.show();
            }
            generateAbsences(loadedAbsences.absences);
        };


        function buildAbsence(absence){
            var html = '<tr class="absence'+ (dateNow > absence["dateTill"]?' closed':'') +'">' +
                    '<td class="control">' +
                        '<span class="edit_button" onclick="AbsenceViewer.get().absenceEditorSection().edit('+ absence.id +')"></span>' +
                        '<span class="duplicate_button" onclick="AbsenceViewer.get().absenceEditorSection().duplicate('+ absence.id +')"></span>' +
                        '<span class="delete_button" onclick="AbsenceViewer.get().absencesSection().deleteAbsence('+ absence.id +')"></span>' +
                    '</td>'

            html += '<td class="id">' +
                        '<a href="/user'+ userId +'/absence'+ absence.id +'" class="link" onclick="AbsenceViewer.get().absenceSection().show('+ absence.id +'); return false">#'+
                        absence.id +
                        '</a>' +
                    '</td>';

            html += '<td class="absenceRange">' +
                        '<div class="from">' +
                        getDateRangeString(new Date(absence["dateFrom"]), '00:00') +
                        '</div> — ' +
                        '<div class="to">' +
                        getDateRangeString(new Date(absence["dateTill"]), '23:59') +
                        '</div>' +
                    '</td>';

            html += '<td class="type">' +
                        '<span class="typeName reason'+ absence.reason +'">' + ABSENCE_REASONS[absence.reason-1] +
                        (absence.reason == 11?'<div class="more_button" onclick="showSchedule(event, '+ absence["schedule"] +')"></div>':'') +
                        '</span>' +
                    '</td>';

            html += '<td class="comment"'+ (absence.comment?' onmouseenter="AbsenceViewer.get().absencesSection().showLongComment(event)"':'') +'>' +
                        '<div class="relativeBlock">' +
                        (absence["comment"]?'<div class="relativeBlock"><div class="text">'+ absence["comment"].escapeHTML() +'</div></div>':'') +
                        '</div>' +
                    '</td>';

            html += '</tr>';

            return html;
        }

        function generateAbsences(absences){
            if(absences && absences.length>0){
                absences.sort(function(a,b){
                    return b.dateFrom - a.dateFrom;
                });
                emptyBlock.hide();
                absenceList.show();
                var html = '';
                for(var i=0; i<absences.length; i++)
                    html += buildAbsence(absences[i]);
                absenceListTbody.html(html);
            }else{
                absenceListTbody.html('');
                absenceList.hide();
                emptyBlock.show();
            }
        }


        this.show = function(absences){
            section.find('.head>.name').text(name);

            if (!dateTime) {
                dateTime = section.find('#dtAv');
                dateTime.dateRangePicker({
                    singleMonth: true,
                    inline: true,
                    showShortcuts: false,
                    showTopbar: false,
                    startOfWeek: "monday",
                    maxDays: 120,
                    format: 'DD.MM.YY',
                    alwaysOpen: true,
                    container: absenceViewer.find('.datePickerWrap'),
                    getValue: function () {
                        return '';
                    },
                    setValue: function (s, date1, date2) {
                        if (absences) {
                            generateAbsences(loadedAbsences.absences = absences);
                            absences = null;
                        } else {
                            loadedAbsences.download(date1, date2, function (data) {
                                generateAbsences(data);
                            });
                        }
                        var format = 'DD.MM.YY';
                        dateTime.find('#tAv1').html(moment(date1).format(format));
                        dateTime.find('#tAv2').html(moment(date2).format(format));
                        loadedAbsences.from = +date1;
                        loadedAbsences.till = +date2;
                    }
                });
            }
            self.pushInQueue();

            dateNow = Date.now();
            var till = new Date(dateNow);
            var from = new Date(dateNow);
            from.setDate(from.getDate() - 3);
            till.setDate(till.getDate() + 3);

            dateTime.data('dateRangePicker').setDateRange(from, till);
            loadedAbsences.from = +from;
            loadedAbsences.till = +till;

            userData[sectionName] = {};
            self.reshow(300);
        };

        this.pushInQueue = function(){
            this._pushInQueue('Отсутствия', new UrlReplacer('/user' + userId +'/absences'));
        };

        function filterBy(i, elem){
            var absences = absenceListTbody.children('.absence');
            if(absences.length == 0)
                return;

            if(i=="0"){
                absences.show();
                absenceList.show();
                emptyBlock.hide();
                return;
            }

            var size = absences.length;
            absences.each(function(i,e){
                e = $(e);
                if(e.find('.typeName').text() != elem) {
                    e.hide();
                    size--;
                }
                else
                    e.show();
            });
            if(size==0){
                absenceList.hide();
                emptyBlock.show();
            }else{
                absenceList.show();
                emptyBlock.hide();
            }
        }

        this.showLongComment = function(event){
            var elem = $(event.currentTarget);
            var textElem = elem.find('.text');
            if(textElem.outerWidth() + 4< elem.width()) // 4 погрешность
                return;

            var popup = $('<div class="message_popup"></div>');
            popup.text(textElem.text());
            elem.children('.relativeBlock').append(popup);

            popup.addClass('active');
            elem.one('mouseleave', function(){
                popup.remove();
            })
        }

    }
    this.absencesSection = singleton.bind(AbsencesSection);


    function AbsenceEditorSection(){
        var section = absenceViewer.find('.absenceEditing:first');
        var today = new Date();
        var mainInfo = section.find('.mainBlock .mainInfo');

        var dateTimeRange = mainInfo.children('.dateTime');
        var dFromElem = dateTimeRange.find('.from .date');
        var tFromElem = dateTimeRange.find('.from .time');
        var dTillElem = dateTimeRange.find('.to .date');
        var tTillElem = dateTimeRange.find('.to .time');
        var absenceReasonBut = mainInfo.find('.absenceReason_button');
        var timePicker = mainInfo.next('.timePicker');
        var commentElem = timePicker.next('.comment').children('.text');
        var loader = section.find('.Loader');

        var selectList;

        var self = this;
        var _sectionName = 'absenceEditorSection';
        var _absence;

        var sliders = {
            twoDays: {
                elem: timePicker.children('.twoDays')
            },
            oneDay: {
                elem: timePicker.children('.oneDay')
            }
        };

        _Section.call(this, section, _sectionName);
        _Schedulable.call(this, _sectionName);

        function updateAbsenceDateRange(date1, date2){
            date1 = date1 || _absence.dateFrom;
            date2 = date2 || _absence.dateTill;
            if(date2 - date1 < 1)// минимальный диапазон 1 минута
                return null;
            dateTimeRange.data('dateRangePicker').setDateRange(date1, date2);
        }

        function generateDateTimePicker(selectorClass, updateAction, timeLimitClass, absenceDatePart){
            var dateTimePicker = new DateTimePicker({
                date: today,
                selector: dateTimeRange.find(selectorClass +' .val'),
                changeAction: updateAction,
                initializeAction: function(){
                    dateTimePicker.getDateTimePicker().children('.time').append(
                        addTimeLimitButton(
                            timeLimitClass,
                            function(time){
                                _absence[absenceDatePart].setHours(time.getHours(), time.getMinutes());
                                updateAction();
                                dateTimePicker.setDate(_absence[absenceDatePart]);
                            }
                        )
                    );
                },
                openAction: function(event){
                    dateTimePicker.setDate(_absence[absenceDatePart]);
                    popupToCenter(dateTimePicker.getDateTimePicker(), $(event.currentTarget));
                }
            });
            dateTimeRange.find(selectorClass).append(dateTimePicker.getDateTimePicker());
        }

        generateDateTimePicker('.from', updateAbsenceDateRange, 'from', 'dateFrom');
        generateDateTimePicker('.to', updateAbsenceDateRange.bind(null, null), 'till', 'dateTill');

        function initialiseSlider(slider){
            if(sliders[slider].sliders)
                return;

            sliders[slider].sliders = sliders[slider].elem.find('.slider > div');

            if(slider=="twoDays"){
                sliders.twoDays.sliders.eq(0).slider({
                    range: "max",
                    min: 0,
                    max: 1425,
                    step: 15,
                    slide: function (e, ui) {
                        setTextTime(tFromElem, setAndGetTimeFromMinutes(_absence.dateFrom, ui.value), 'с')
                    }
                });
                sliders.twoDays.sliders.eq(1).slider({
                    range: "min",
                    min: 15,
                    max: 1440,
                    step: 15,
                    slide: function (e, ui) {
                        setTextTime(tTillElem, setAndGetTimeFromMinutes(_absence.dateTill, ui.value), 'до')
                    }
                });
            }else{
                sliders.oneDay.sliders.slider({
                    range: true,
                    min: 0,
                    max: 1440,
                    step: 5,
                    slide: function (e, ui) {
                        if (ui.values[1] - ui.values[0] < 5)
                            return false;
                        setTextTime(tFromElem, setAndGetTimeFromMinutes(_absence.dateFrom, ui.values[0]))
                        setTextTime(tTillElem, setAndGetTimeFromMinutes(_absence.dateTill, ui.values[1]))
                    }
                });
            }
        }

        dateTimeRange.dateRangePicker({
            singleMonth: true,
            inline: true,
            format: 'DD.MM.YY',
            showShortcuts: false,
            showTopbar: false,
            startOfWeek: "monday",
            alwaysOpen: true,
            separator: ' ',
            container: section.find('.datePicker div'),
            setValue: function (s, date1, date2, isSpecified) {
                STOP();
                if(!isSpecified){
                    date1.setHours(0,0);
                    date2.setHours(23,59);
                }
                var dates = s.split(' ');
                dFromElem.text(dates[0]);
                dTillElem.text(dates[1]);

                _absence.dateFrom.setFullYear(date1.getFullYear(), date1.getMonth(), date1.getDate())
                _absence.dateFrom.setHours(date1.getHours(), date1.getMinutes());
                _absence.dateTill.setFullYear(date2.getFullYear(), date2.getMonth(), date2.getDate());
                _absence.dateTill.setHours(date2.getHours(), date2.getMinutes());

                var isTwoDays = date1.getDate() != date2.getDate() || date1.getMonth() != date2.getMonth() || date1.getFullYear() != date2.getFullYear()

                setTextTime(tFromElem, date1, isTwoDays?'с':null)
                setTextTime(tTillElem, date2, isTwoDays?'до':null)
                changeSliders(
                        isTwoDays,
                        date1.getHours() * 60 + date1.getMinutes(),
                        date2.getHours() * 60 + date2.getMinutes()
                );
            }
        });

        this.saveAbsence = function(){
            var isNew = !_absence.id;
            _absence.dateFrom.setSeconds(0,0);
            _absence.dateTill.setSeconds(0,0);
            _absence.comment = commentElem.val();


            if(_absence.comment.length > 500){
                MessageGenerator.get().show("Ошибка! Ваш комментарий превысил размер в 500 символов", "error", 5);
                return;
            }
            if(_absence.dateFrom >= _absence.dateTill){
                MessageGenerator.get().show("Ошибка! Неправильный диапазон дат", "error", 5);
                return;
            }
            if(_absence.reason == 11 && typeof _absence.schedule != "string"){ // расписание
                if(jQuery.isEmptyObject(_absence.schedule)){
                    MessageGenerator.get().show("Ошибка! Заполните расписание", "error", 5);
                    return;
                }
                if(_absence.schedule.weekNumber == 1)
                    _absence.schedule = _absence.schedule['чёт'];

                delete _absence.schedule.weekNumber;

                //scheduleObject = _absence.schedule;
                _absence.schedule = JSON.stringify(_absence.schedule);
            }

            _absence.personId = userId;
            loader.addClass('active');

            var errorF = function(){
                MessageGenerator.get().show("Ошибка! Обновите страницу и попробуйте ещё раз", "error", 10);
                loader.removeClass('active')
            };

            AJAX.saveEmployeeAbsence(
                _absence,
                function(data){
                    if(data > 0){
                        MessageGenerator.get().show("Отсутствие сохранено", "success", 6);
                        _absence.id = +data;
                        //_absence.schedule = scheduleObject;

                        changes[_absence.id] = {
                            type: isNew?'created':'updated',
                            absence: _absence
                        };

                        windowQueue[windowQueue.length - 1].changed = true; // изменяем в любом случае, если отсутствие вышло из диапазона, то его надо убрать из списка

                        if(loadedAbsences.from < +_absence.dateTill && loadedAbsences.till > +_absence.dateFrom ){
                            if(isNew)
                                loadedAbsences.absences.push(_absence);
                            else {
                                loadedAbsences.findId(_absence.id, function(i){
                                    loadedAbsences.absences[i] = _absence;
                                });
                            }
                        }else if(!isNew){
                            loadedAbsences.findId(_absence.id, function(i){
                                loadedAbsences.absences.splice(i, 1);
                            });
                        }

                        userData[_sectionName].absenceId = _absence.id;

                        loader.removeClass('active')
                    }else
                        errorF()
                }
            ).fail(errorF);
        };

        function changeSliders(isTwoDays, dateFromPos, dateTillPos) {
            sliders.oneDay.elem.toggle(!isTwoDays);
            sliders.twoDays.elem.toggle(isTwoDays);
            if (isTwoDays) {
                initialiseSlider("twoDays")
                sliders.twoDays.sliders.eq(0).slider("value", dateFromPos);
                sliders.twoDays.sliders.eq(1).slider("value", dateTillPos); // -15
            } else {
                initialiseSlider("oneDay")
                sliders.oneDay.sliders.slider("values", [dateFromPos, dateTillPos]);
            }
        }

        function setAndGetTimeFromMinutes(timePart, minutes){
            var hours = Math.floor(minutes/ 60);
            minutes -= hours * 60;
            if(hours == 24){
                hours = 23;
                minutes = 59;
            }
            timePart.setHours(hours, minutes);
            return {
                getHours: function(){return hours},
                getMinutes: function(){return minutes}
            }
        }


        function setTextTime(timeElem, date, textPrefix){
            var hours = date.getHours();
            var minutes = date.getMinutes();
            var startOfDay, endOfDay;
            if(textPrefix){
                startOfDay = endOfDay = textPrefix
            }else{
                startOfDay = 'c';
                endOfDay = 'до'
            }

            if (hours == 0 && minutes == 0)
                return timeElem.text(startOfDay +' начала дня');
            else if (hours == 23 && minutes == 59)
                return timeElem.text(endOfDay +' конца дня');
            else
                timeElem.text(getTwoDigitNumber(hours) +':'+ getTwoDigitNumber(minutes));
        }

        this.edit = function(absenceId){
            this.show(loadedAbsences.getById(absenceId, true));
        };

        this.duplicate = function(absenceId){
            var absence = $.extend(true, {}, loadedAbsences.getById(absenceId, true));
            absence.id = null;

            if(windowQueue[windowQueue.length - 1].section == AbsenceViewer.get().absenceSection())
                windowQueue.pop().section.close(300);

            this.show(absence);
        };

        this.pushInQueue = function(id){
            if(id)
                this._pushInQueue('Отсутствие #'+ id, new UrlReplacer('/user' + userId +'/absence'+ id +'/edit'));
            else
                this._pushInQueue('Новое отсутствие', new UrlReplacer('/user' + userId +'/newAbsence'));
        };

        var _close = this.close;
        this.close = function(afterTime){
            _close(afterTime);
            section.find('.tc_wrapper.scheduleBlock').children('.dimension_wrapper').remove();
            section.removeClass('schedule_showing');
        };

        this.show = function(absence){
            var sectionName;

            self.buildParentsToolBar();

            if(absence){
                _absence = $.extend(true, {}, absence);
                _absence.dateFrom = new Date(_absence.dateFrom);
                _absence.dateTill = new Date(_absence.dateTill);
            }else{
                _absence = {
                    dateFrom: new Date(+today),
                    dateTill: new Date(today.getFullYear(), today.getMonth(), today.getDate(), 23, 59),
                    reason: 4 //личные дела
                };
            }
            if(_absence.id){
                sectionName = 'Отсутствие #'+ absence.id;
                this.pushInQueue(absence.id);
            }else{
                sectionName = 'Новое отсутствие';
                this.pushInQueue();
            }


            if(!selectList)
                selectList = new SelectList({
                    selector: absenceReasonBut,
                    outerSelector: absenceReasonBut.parent(),
                    openAction: function(){
                        selectList.setActiveIndex(_absence.reason);
                        selectList.getSelectList().css('min-width', this.selector.outerWidth()).css('margin-top', 2);
                    },
                    changeAction: function(key, val){
                        _absence.reason = key;

                        var scheduleBlock = section.find('.scheduleBlock');
                        absenceReasonBut.text(val)[0].className = 'absenceReason_button reason'+ key;

                        if(key == 11){
                            if(!_absence.schedule)
                                _absence.schedule = {};
                            scheduleBlock.html(self.showScheduleBlock(_absence.schedule));
                            activateScheduleBlock(scheduleBlock.find('.time'), _absence.schedule);

                            var w = getBlockWidth(scheduleBlock);

                            scheduleBlock.addClass('active').css('overflow', 'hidden').css('max-width', 0);
                            section.addClass('schedule_showing');
                            setTimeout(function(){
                                scheduleBlock.css('max-width', w);
                                setTimeout(function () {
                                    scheduleBlock.css('max-width', '').css('overflow', '');
                                }, 300)
                            }, 100)
                        }else{
                            scheduleBlock.css('max-width', getBlockWidth(scheduleBlock)).css('overflow', 'hidden');
                            setTimeout(function () {
                                scheduleBlock.css('max-width', 0);
                                section.removeClass('schedule_showing');
                                setTimeout(function () {
                                    scheduleBlock.removeClass('active').css('max-width', '').css('overflow', '')
                                    scheduleBlock.html('');
                                }, 300)
                            }, 100)
                        }
                    },
                    dataList: {
                        "3":"Болезнь",
                        "7":"Больничный лист",
                        "8":"Гостевой пропуск",
                        "1":"Командировка",
                        "4":"Личные дела",
                        "5":"Местная командировка",
                        "9":"Ночные работы",
                        "2":"Отпуск",
                        "10":"Отпуск за свой счёт",
                        "11":"Расписание",
                        "6":"Учёба"
                    }
                });


            var scheduleBlock = section.find('.scheduleBlock');
            if(_absence.reason == 11){
                var schedule = JSON.parse(_absence.schedule);
                scheduleBlock.addClass('active').html(self.showScheduleBlock(schedule));
                activateScheduleBlock(scheduleBlock.find('.time'), schedule);
                section.addClass('schedule_showing');
            }else{
                scheduleBlock.removeClass('active').html('');
                section.removeClass('schedule_showing');
            }

            section.find('.head>.name').text(name);
            section.find('.sectionName').text(sectionName);

            dateTimeRange.data('dateRangePicker').setDateRange(_absence.dateFrom, _absence.dateTill);

            timePicker.next('.comment').children('.text').val(_absence.comment?_absence.comment:'');

            absenceReasonBut.text(ABSENCE_REASONS[_absence.reason - 1]);
            absenceReasonBut[0].className = 'absenceReason_button reason'+ _absence.reason;

            userData[_sectionName] = {};
            if(_absence.id)
                userData[_sectionName].absenceId = _absence.id;

            self.reshow(300);
        };

        this.changeWeek = function(event){
            var wn, weekTitle, weekNumber = + $(event.currentTarget).attr('data-weekNumber');
            var scheduleBlock = section.find('.tc_wrapper.scheduleBlock');
            if(weekNumber == 2){
                wn = 1;
                weekTitle = 'Чётная и нечётная недели';
                scheduleBlock.children('.dimension_wrapper').addClass('oneWeek_showing');
            }else{
                wn = 2;
                weekTitle = 'Чётная неделя';
                scheduleBlock.children('.dimension_wrapper').removeClass('oneWeek_showing');
            }
            scheduleBlock.find('.weekParity_button').text(wn +'нед.').attr('data-weekNumber', wn);
            scheduleBlock.find('.headers .week').first().text(weekTitle);
            _absence.schedule.weekNumber = wn;
        };

        this.showScheduleBlock = function(schedule){
            var weekNumber = schedule['чёт'] || schedule['нечёт'] || $.isEmptyObject(schedule)?2:1;
            return $(this.generateScheduleBlock(schedule, weekNumber));
        };

        function activateScheduleBlock(times, schedule){
            //schedule = absence.schedule || {};
            if($.isEmptyObject(schedule) || schedule['чёт'] || schedule['нечёт'] ){
                schedule['чёт'] = schedule['чёт'] || {};
                schedule['нечёт'] = schedule['нечёт'] || {};
                schedule.weekNumber = 2;
            }else{
                schedule = {'чёт': schedule, 'нечёт': {}};
                schedule.weekNumber = 1;
            }

            function activate(i, e){
                e = $(e);
                var parent = e.parent();
                var parityWeek = parent.attr('data-parity');
                var day = +parent.attr('data-day');

                var from, till;

                if(!schedule[parityWeek][DAYS[(i%5) + 1]]){
                    from =  new Date(2000, 0, 1, 0, 0);
                    till =  new Date(2000, 0, 1, 23, 59);
                }else{
                    var times = schedule[parityWeek][DAYS[(i%5) + 1]].split('-');
                    var f = times[0].split(':');
                    var t = times[1].split(':');

                    from =  new Date(2000, 0, 1, f[0], f[1]);
                    till =  new Date(2000, 0, 1, t[0], t[1]);
                    updateScheduleDayDateRange(e, from, till);
                }

                var dateTimeRangePicker = new DateTimeRangePicker({
                    dateFrom: from,
                    dateTill: till,
                    type: 'timePicker',
                    selector: e,
                    changeAction: function(datePart, dFrom, dTill){
                        if(dFrom >= dTill)
                            return null;

                        schedule[parityWeek][DAYS[day + 1]] = updateScheduleDayDateRange(e, dFrom, dTill);

                    },
                    initializeAction: function(){
                        var datePickerFrom = dateTimeRangePicker.getDateFromPicker();
                        var datePickerTill = dateTimeRangePicker.getDateTillPicker();

                        function updateAction(tFrom, tTill){
                            schedule[parityWeek][DAYS[day + 1]] = updateScheduleDayDateRange(e, tFrom, tTill);
                        }

                        var timePart = dateTimeRangePicker.getDateTimePicker().find('.time');

                        timePart.eq(0).prepend(
                                addTimeLimitButton(
                                        'from',
                                        function(time){
                                            updateAction(time,  datePickerTill.getDate());
                                            datePickerFrom.setDate(time);
                                        }
                                )
                        );

                        timePart.eq(1).append(
                                addTimeLimitButton(
                                        'till',
                                        function(time){
                                            updateAction(datePickerFrom.getDate(), time);
                                            datePickerTill.setDate(time);
                                        }
                                )
                        );
                    },
                    openAction: function(event){
                        popupToCenter(dateTimeRangePicker.getDateTimePicker(), $(event.currentTarget));
                    }
                });
                e.after(dateTimeRangePicker.getDateTimePicker())
            }

            times.filter(':odd').each(activate);
            times.filter(':even').each(activate);
        }

        function addTimeLimitButton(className, updateAction){
            var time;
            if(className == 'from') time = new Date(2000, 0, 1, 0, 0);
            else time = new Date(2000, 0, 1, 23, 59);

            var timeLimitBut = $('<div class="timeLimit_button '+ className +'"></div>');

            timeLimitBut.on('click', function(){
                updateAction(time);
            });
            return timeLimitBut;
        }

        function updateScheduleDayDateRange(elem, dFrom, dTill){
            dFrom = timeToString(dFrom);
            dTill = timeToString(dTill);

            elem.html(
                '<span class="from'+ (dFrom =='00:00'?' timeLimit">':'">' + dFrom) +'</span>' +
                '—' +
                '<span class="to'+ (dTill =='23:59'?' timeLimit">':'">' + dTill) +'</span>'
            ).removeClass('newTime_button');
            return dFrom +'-'+ dTill
        }
    }
    this.absenceEditorSection = singleton.bind(AbsenceEditorSection);






    this.show = function(sectionRun, personName, personId, winQueueRun){
        name = personName;
        userId = personId;
        windowQueue = [];
        changes = {};
        userData = {};

        $(document.body).css('overflow','hidden');

        if(winQueueRun)
            winQueueRun.call(this); // вставляем в очередь окна, как будто они уже были открыты до этого
        sectionRun.call(this); // показываем нужную секцию

        absenceViewer.show();
        setTimeout(function () {
            absenceViewer.addClass('active');
            helper.showIfNotShown(4);
        }, 200);

        return closeAfterDeferred = $.Deferred()
    };

    this.close = function(){
        absenceViewer.removeClass('active');
        $(document.body).css('overflow','');

        windowQueue[0].url.revert();

        for(var i = 0; i < windowQueue.length; i++){ // Удаляем предыдущие
            //windowQueue[i].section.removeClass('active').hide();
            windowQueue[i].section.close();
        }

        closeAfterDeferred.resolve(changes);
        setTimeout(function () {
            absenceViewer.hide();
        }, 300);
    };

    function getDateRangeString(date, initiallyTime){
        var hm = getTwoDigitNumber(date.getHours()) +':'+ getTwoDigitNumber(date.getMinutes());
        return '<div class="dateNumber">' +
                    getTwoDigitNumber(date.getDate()) +
                '</div>' +
                '<div class="monthTime">' +
                    '<div class="month">'+ MONTHS[date.getMonth()] +'</div>' +
                     (hm != initiallyTime?'<div class="time">'+ hm +'</div>':'') +
                '</div>';
    }

}
AbsenceViewer.get = singleton.bind(AbsenceViewer);</script>
      <script>
        function UrlReplacer(newUrl, prevUrl){
            if(!prevUrl)
                prevUrl = window.location.pathname;
            this.revert = function(){
                history.pushState(null, null, prevUrl)
            }
            this.getNewUrl = function(){
                return newUrl;
            }
            history.pushState(null, null, newUrl);
        }
        
        
      </script>
      <script>
        function ConfirmGenerator(){
            function generateConfirm(text, confirmType, confirmButtonName){
                return '<div class="popup_backgroundBlock simplePopup">' +
                            '<div class="wrapper">' +
                                '<div class="popupBlock">' +
                                    '<div class="confirmGenerator '+ confirmType +'">' +
                                        '<div class="body">' +
                                            '<div class="icon-mIcon"></div>' +
                                            '<div class="text">'+ text +'</div>' +
                                        '</div>'+
                                        '<div class="footer">' +
                                            '<div class="button confirm_button">'+ confirmButtonName +'</div>' +
                                            '<div class="button grayC">Отмена</div>' +
                                        '</div>'+
                                    '</div>'+
                                '</div>'+
                            '</div>'+
                        '</div>';
            }
        
        
            function close(popup, confirmPopup){
                popup.removeClass('active');
                confirmPopup.removeClass('active');
                setTimeout(function(){
                    popup.remove();
                }, 300)
            }
        
            this.show = function(question, type, confirmButtonName, successHandler, cancelHandler){
                var popup = $(generateConfirm(question, type, confirmButtonName));
                var confirmPopup = popup.find('.confirmGenerator');
                $(document.body).append(popup);
        
                popup.find('.confirm_button').on('click', function(){
                    if(successHandler)
                        successHandler();
                    close(popup, confirmPopup);
                }).next('.button').on('click', function(){
                    if(cancelHandler)
                        cancelHandler();
                    close(popup, confirmPopup);
                })
        
                setTimeout(function(){
                    popup.addClass('active');
                    setTimeout(function(){
                        confirmPopup.addClass('active');
                    }, 10)
                }, 10)
            }
        
        }
        ConfirmGenerator.get = singleton.bind(ConfirmGenerator)
        
        
      </script><script>/**
 * require getTwoDigitNumber
 **/


function WheelPicker(options){
    var wheelPicker = $(
        '<div class="toUp"></div>' +
        '<div class="val"></div>' +
        '<div class="toDown"></div>'
    );
    var toUpButton = wheelPicker.filter('.toUp');
    var value = wheelPicker.filter('.val');
    var toDownButton = wheelPicker.filter('.toDown');
    var index, circular, changeAction; // если changeAction возвращает null, значит откат

    function trySetIndexAgain(val, from, till){
        if(val < from)
            return till;
        else if(val > till)
            return from;
        return val;
    }

    function changeVal(factor, withoutChangeAction){
        var temp = index + factor;
        if(options.type == 'numberRange'){
            if(circular)
                temp = trySetIndexAgain(temp, options.from, options.till);
            else if(temp < options.from || temp > options.till)
                return;

            if(withoutChangeAction || changeAction(temp) !== null){
                index = temp;
                value.text(getTwoDigitNumber(index));
            }

        }else if(options.type == 'vals'){
            if(circular)
                temp = trySetIndexAgain(temp, 0, options.vals.length - 1);
            else if(options.vals[temp] === undefined)
                return;

            if(withoutChangeAction || changeAction(temp, options.vals[temp]) !== null){
                index = temp;
                value.text(options.vals[index]);
            }


        }
    }

    this.getWheelPicker = function(){
        return wheelPicker;
    };

    function changeValOneOrMoreTimes(factor){
        var timerId, intervalId;

        $(document.body).one('mouseup', function () {
            clearTimeout(timerId);
            clearInterval(intervalId);
        });

        timerId = setTimeout(function(){
            intervalId = setInterval(function(){
                changeVal(factor);
            }, 100);
        }, 500);

        changeVal(factor);
    }

    function onWheel(event){
        var delta = event.originalEvent.deltaY || event.originalEvent.detail || event.originalEvent.wheelDelta;
        changeVal(delta > 0?-1:1);
        event.preventDefault();
    }

    this.destroy = function(){
        wheelPicker.remove();
    };

    this.changeOptions = function(newOptions, withIndex){
        options = newOptions;
        circular = newOptions.circular || true;
        changeAction = newOptions.changeAction||$.noop;
        if(withIndex)
            index = options.index;
    };

    this.getIndex = function(){
        return index;
    };

    this.setIndex = function(newIndex){
        index = newIndex;
        changeVal(0);
    };

    this.setIndexNoAffect = function(newIndex){
        index = newIndex;
        changeVal(0, true);
    };


    this.changeOptions(options, true);

    toDownButton.on('mousedown', changeValOneOrMoreTimes.bind(null, -1));
    toUpButton.on('mousedown', changeValOneOrMoreTimes.bind(null, 1));
    value.on('wheel', onWheel.bind(this));

    changeAction = $.noop;
    changeVal(0);
    changeAction = options.changeAction||$.noop;
}
</script><script>/**
 * require WheelPicker.js
 * require MONTHS
 * require bindDocumentKillingClick2
 * Date.daysInMonth
**/


function _DateTimePicker(picker, changeAction){
    this.dateParts = {};
    var date;

    this._setDate = function(newDate){
        date = newDate;
    };

    this.generateOneTime = function(){
        this.dateParts.hours = new WheelPicker({
            type:  'numberRange',
            from: 0,
            till: 23,
            index: date.getHours(),
            changeAction: function(i){
                var val = date.getHours();
                date.setHours(i);
                if(changeAction(date) === null){
                    date.setHours(val);
                }
            }
        });

        this.dateParts.minutes = new WheelPicker({
            type:  'numberRange',
            from: 0,
            till: 59,
            index: date.getMinutes(),
            changeAction: function(i){
                var val = date.getMinutes();
                date.setMinutes(i);
                if(changeAction(date) === null){
                    date.setMinutes(val);
                }
            }
        });

        var dateTimePicker = $(
            '<div class="part time">' +
            '<div class="part timeParts">' +
            '<div class="part hours"></div>' +
            ':' +
            '<div class="part minutes"></div>' +
            '</div>' +
            '</div>'
        );

        dateTimePicker.find('.hours').append(this.dateParts.hours.getWheelPicker());
        dateTimePicker.find('.minutes').append(this.dateParts.minutes.getWheelPicker());
        return dateTimePicker;
    };

    this.generateOneDate = function(){
        var dateOptions = {
            type:  'numberRange',
            from: 1,
            till: date.daysInMonth(),
            index: date.getDate(),
            changeAction: function(i){
                var val = date.getDate();
                date.setDate(i);
                if(changeAction(date) === null){
                    date.setDate(val);
                }
            }
        };

        function changeAndSetDateOptions(days){
            dateOptions.till = DAYS;
            dateNumber.changeOptions(dateOptions);

            if(dateNumber.getIndex() > DAYS){
                dateNumber.setIndex(DAYS);
            }
        }

        var dateNumber = this.dateParts.date = new WheelPicker(dateOptions);
        this.dateParts.month = new WheelPicker({
            type:  'vals',
            vals: MONTHS,
            index: date.getMonth(),
            changeAction: function(i){
                var m = date.getMonth(), d = date.getDate();
                date.setMonth(i);
                if(changeAction(date) === null){
                    date.setMonth(m, d);
                }
                else
                    changeAndSetDateOptions(
                        Date.daysInMonth(date.getFullYear(), i)
                    );
            }
        });

        var currentYear = date.getFullYear();
        this.dateParts.year = new WheelPicker({
            type:  'numberRange',
            from: currentYear - 2,
            till: currentYear + 2,
            index: currentYear,
            changeAction: function(i){
                var y = date.getFullYear(), d = date.getDate();
                date.setFullYear(i);
                if(changeAction(date) === null){
                    date.setFullYear(y, date.getMonth(), d);
                }
                else
                    changeAndSetDateOptions(
                        Date.daysInMonth(i, date.getMonth())
                    );
            }
        });


        var dateTimePicker = $(
            '<div class="part date"></div>' +
            '<div class="part month"></div>' +
            '<div class="part year"></div>'
        );

        dateTimePicker.filter('.date').append(dateNumber.getWheelPicker());
        dateTimePicker.filter('.month').append(this.dateParts.month.getWheelPicker());
        dateTimePicker.filter('.year').append(this.dateParts.year.getWheelPicker());
        return dateTimePicker;
    };

    this.destroy = function(){
        picker.remove();
        selector.off('click');
    };

    this.close = function(){
        picker.removeClass('active');
    };

    this.getDateTimePicker = function(){
        return picker;
    };
}


function DateTimePicker(options){
    var date = new Date(+options.date);
    var selector = options.selector;
    var type = options.type;
    var changeAction = options.changeAction || $.noop; // если changeAction возвращает null, значит откат
    var openAction = options.openAction || $.noop;
    var isInitialized;
    var picker = $('<div class="dateTimePicker"></div>');
    var self = this;

    _DateTimePicker.call(this, picker, changeAction);

    this.initialize = function(){
        var dateTimePicker;

        this._setDate(date);
        switch(type){
            case 'timePicker':
                dateTimePicker = this.generateOneTime();
            break;
            default:
                dateTimePicker = this.generateOneDate().add(this.generateOneTime());
        }

        picker.append(dateTimePicker);
        (options.initializeAction || $.noop)();
    };

    if(selector) {
        selector.on('click', function (event){
            if (picker.hasClass('active'))
                return self.close();

            if (!isInitialized) {
                self.initialize();
                isInitialized = true;
            }

            picker.addClass('active');
            openAction(event);
            bindDocumentKillingClick2(self.close, picker, selector);
            event.stopPropagation();
        });
    }

    this.getDate = function () {
        return date;
    };
    this.setDate = function (newDate) {
        this._setDate(date = new Date(+newDate));

        this.dateParts.hours.setIndexNoAffect(newDate.getHours());
        this.dateParts.minutes.setIndexNoAffect(newDate.getMinutes());
        if(type == 'timePicker')
            return;
        this.dateParts.date.setIndexNoAffect(newDate.getDate());
        this.dateParts.month.setIndexNoAffect(newDate.getMonth());
        this.dateParts.year.setIndexNoAffect(newDate.getFullYear());
    };
}


function DateTimeRangePicker(options){
    var picker = $('<div class="dateTimePickerRange"></div>');
    var selector = options.selector;
    var changeAction = options.changeAction || $.noop; // если changeAction возвращает null, значит откат
    var openAction = options.openAction || $.noop;
    var isInitialized;
    var self = this;

    _DateTimePicker.call(this, picker);

    var dateFromPicker = new DateTimePicker({
        type: options.type,
        date: options.dateFrom,
        changeAction: function(date){
            return changeAction('from', date, dateTillPicker.getDate());
        }
    });
    var dateTillPicker = new DateTimePicker({
        type: options.type,
        date: options.dateTill,
        changeAction: function(date){
            return changeAction('till', dateFromPicker.getDate(), date);
        }
    });

    this.getDateFromPicker = function(){
        return dateFromPicker;
    };

    this.getDateTillPicker = function(){
        return dateTillPicker;
    };

    selector.on('click', function (event){
        if(picker.hasClass('active'))
            return self.close();

        if(!isInitialized){
            dateFromPicker.initialize();
            dateTillPicker.initialize();
            picker.append(
                dateFromPicker.getDateTimePicker().addClass('active')
                    .add('<span>—</span>')
                    .add(
                    dateTillPicker.getDateTimePicker().addClass('active')
                )
            );
            (options.initializeAction || $.noop)();
            isInitialized = true;
        }

        picker.addClass('active');
        openAction(event);
        bindDocumentKillingClick2(self.close, picker, selector);
        event.stopPropagation();
    });



}</script><script>/**
 * require:
 * MessageGenerator
 * $.cookie
 */

function Helper(){
    var tooltips = {
        "1": ["Удерживайте клавишу Ctrl при клике на фильтр для их комбинации"],
        "2": ["При комбинации фильтров всегда используется оператор И, порядок их применения не имеет значения"],
        "4": ["Обратите внимание, при открытии большинства модальных окн меняется url в адресной строке вашего браузера!"]
    };


    var props = $.cookie('userProps');
    props = props || 0;

    this.ifShowing = function(key){
        return (props & key) == key;
    };
    this.setProp = function(key){
        props |= key;
        $.cookie('userProps', props);
    };
    this.removeProp = function(key){
        props &= ~key;
        $.cookie('userProps', props);
    };
    this.showIfNotShown = function(key, showAfterMilliSeconds){
        if((props & key) != key){
            props |= key;
            $.cookie('userProps', props);
            MessageGenerator.get().show(tooltips[key][0], "info", tooltips[key][1], showAfterMilliSeconds);
        }
    }
}
</script>
      <script>
        var helper = new Helper();
        function getBlockWidth(elem) {
            var w = elem.addClass('sizeDiscover').outerWidth();
            elem.removeClass('sizeDiscover');
            return w;
        }
        new CompanyWindow().init();
        
        
        //var diagramProducer = DiagramProducer.get();
        //
        //diagramProducer.build(${p.id}, [<#list absences as abcence>
        //    {
        //        "comment": ${abcence.comment!"null"},
        //        "dateFrom": ${abcence.fromTime?long?c},
        //        "dateTill": ${abcence.tillTime?long?c},
        //        "reason": ${abcence.reasonId},
        //    }
        //    <#sep>,</#list>], 60);
        //diagramProducer.diagramToCenter();
        //
        //    <#if openAbsenceViewer??>
        //var d = new Date();
        //AbsenceViewer.get().show(${p.id}, "${p.displayName}", d, d);
        //<#elseif currentAbsence??>
        //showAbsencePopup(${currentAbsence.created?long?c}, ${currentAbsence.updated?long?c}, "${currentAbsence.creator}", ${currentAbsence.fromTime?long?c}, ${currentAbsence.tillTime?long?c}, ${currentAbsence.reasonId}, "${currentAbsence.userComment}");
        //</#if>
        //
        //$('#editAbsenceButton').click(function () {
        //    var now = new Date();
        //    AbsenceViewer.get().show(${p.id}, "${p.displayName}", new Date(now.getFullYear(), now.getMonth(), now.getDate() - 7), now);
        //});
      </script>
    </div>
  </body>
</html>