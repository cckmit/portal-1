---
title: "Деплой"
description: >
  Действия при деплое Portal
type: docs
weight: 1
gitlab_project_path: "department-7/portal"
gitlab_project_name: "portal"
gitlab_docs_branch: "master"
gitlab_docs_path: "docs"
gitlab_docs_enable_edit: true
gitlab_docs_enable_edit_ide: true
gitlab_docs_enable_new_issue: false
---

## Работа support-менеджера


Основные обязанности:


1. Выдача права при создании задач в YT о выдаче прав.
2. Выполнение обязанностей релиз-менеджера. В неделю деплоя - установка релиза. В неделю после деплоя - установка хотфиксов при необходимости.
3. Ответы на вопросы и исследование багов, поступающих в канал mattermost PORTAL (https://mattermost.protei.ru/protei/channels/portal).
4. Просмотр error логов на prod зонах (192.168.110.68 и 10.0.0.18). Анализ ошибок, создание задач на YT по найденным багам.
5. Отслеживание новых задач в Youtrack. Исследовать новые баги, отписываться по причинам и по вариантами решения. Для удобного отслеживания новых задач на Youtrack надо создать сохраненный поиск по нему создать новую подписку на рассылку писем с youtrack. 


Для создания сохраненного поиска и подписки на него:


* Открыть селектор сохраненных поисков слева страницы.
* Внизу селектора нажать на ссылку «Новый сохраненный поиск…«
* В поле «Запрос» ввести «проект: PORTAL». Заполнить поле имя.
* Внизу формы открыть «Подписки» и выбрать пункт «Создание задач». Сохранить поиск.


Другой вариант управления подписками на созданные сохраненные поиски: в правом верхнем углу нажать на иконку профиля → «Профиль» → сверху вкладка «Уведомления» → пункт «Подписки» → «Новая подписка». 




## Работа с релизом


В конце недели разработки из **develop** выделяем ветку **release-sN**, собираем (на jenkins **build_Portal_by_branch**) и отдаём на тестирование.
В случае появления проблем, доработок, которые должны войти в релиз, бранчуемся от релизной ветки, изменения мержим и в релиз и в дефолт. **Не забываем собирать релизную ветку для тестирования с изменениями.**
Когда тестирование закончено, релизную ветку мержим в master и закрываем **release-sN**.
Для установки собираем **master** - с помощью джобы на jenkins **master build** или **build_Portal_by_branch**.


## Установка релиза
### Ручной


Релиз-менеджер принимает решение о том, какой способ деплоя выбрать исходя из особенностей инсталляции - изменения в бд, конфигурационные файлы.

Обновление портала производится на **portal.protei.ru** и на **crm2.protei.ru**: 



1. отправляем письмо на bbs@protei.ru с информацией о времени обновления. За сутки - приблизительное время, за час - точное.
2. делаем бэкап старой версии портала сюда /usr/protei/backup
3. в установленное время обновляем портал
4. отправляем письмо на bbs@protei.ru с информацией о включенных в релиз доработках.


 На portal.protei.ru tomcat здесь **/opt/tomcat/latest**, команды для управления:

* service tomcat stop
* service tomcat start


На crm2.protei.ru tomcat здесь **/usr/protei/webserver.prod**, для управления можно использовать скрипты:

* stop
* start


Не забываем менять, добавлять параметры в случае необходимости в конфиги - папка **cfg**. Во избежание потери информации перезаливать конфиги **НЕ РЕКОМЕНДУЕТСЯ**.

Письмо с информацией о включенных доработках можно сформировать в youtrack:
В поиске вводим: **Доска PORTAL: {Спринт N} Состояние: Verified, Done** → на панели, рядом с пунктом **Отчеты**, кликаем на «уголочек» выпадающего списка → **Другие представления** → **Примечания к версии**. 


### Автоматический
#### Дженкинс джобы

https://jenkins.protei.ru/job/team7/job/Portal/job/deploy-jobs/

1. prod-and-crm2-deploy - основная работа
2. crm2-deploy - отдельная, так как плагин деплоя может только один варник задеплоить (а тут portal.war для 110.68 и crm.war для 10.0.0.18)


#### Порядок работы Джобы

1. Остановка приложений “Portal”(192.168.110.68) и “Crm”(10.0.0.18) через HTTP запрос (сам томкат работает)
2. Бэкап
   - если стоит галочка “prodbackup” вызывается скрипт 110.68@/home/support/deploy/backup.sh который сохраняет архивы в
       - “/usr/protei/backup/db/beforedeploy” - базу portal
       - “/usr/protei/backup/config” - конфиг /opt/tomcat/latest/cfg
       - “/usr/protei/backup/web” - предыдущую сборку /opt/tomcat/latest/webapps/portal
   - если стоит галочка “crmbackup” вызывается скрипт 10.0.0.18@/home/jenkins/deploy/backup.sh который сохраняет архивы в
       - “/usr/protei/backup/config” - конфиг “/tomcat/cfg”
       - “/usr/protei/backup/web” - предыдущую сборку “/tomcat/webapps/crm”
3. Патч конфигурации, Файл загружается в папку “cfg”, применяется команда patch, после файл удаляется.
   - если загружен файл “prodcfgpatch.txt” - происходит патч конфигурации Portal
   - если загружен файл “crmcfgpatch.txt” - происходит патч конфигурации Crm
4. Патч базы
   -  если загружен файл dbpatch.sql - происходит патч базы. Это обычный sql файл. В начале не забыть выбрать базу «use portal;»
5. Деплой через плагин на томкат 110.68 - запуск приложения
6. Деплой через плагин на томкат 10.0.0.18 - запуск приложения
   - В первой джобе подготавливается crm.war c подменой portal.html на crm.html
   - Вторая джоба автоматически запускается после успешно выполненной первой, копирует “crm.war”, деплоит на томкат


Файл cfg-patch.txt создается таким образом


- перед деплоем качается текущая конфигурация
- вносятся изменения
- делается diff
- данный дифф передается для патча конфиги на сервере


**Пример “deploy_20200719.zip”**


[deploy_20201210.zip](deploy_20201210.zip)



1. /cfg(/crm) - файл конфигурации 110.68 и 10.0.0.18 соответвенно.
   - “portal.properties” - оригинальный
   - “portal_edit.properties” - конфигурация с изменениями
2. /result - подготовленные файлы для деплоя
   - “cfg-patch.txt” - патч конфигурации Portal
   - “crm-patch.txt” - патч конфигурации Crm “db-patch.sql” - патч базы
3. download_cfg.sh / download_crm_cfg.sh- скрипты для скачки конфигурации портала конфигурация
4. make_patch.sh / make_crm_patch.sh - сделать патч конфигурации


**Скрипты “script_20201719.zip”**


[script_20201719.zip](script_20201719.zip )


Текущие скрипты на рабочих машинах


**Пользователи**


На зоне 10.0.0.18 для бэкапа и патча конфигураций используется пользователь jenkins.

Для логина используется публичный ключ. Логин только с зоны jenkins

Пользователь jenkins добавлен в группу tomcat, через которую получает все нужные права. 


## Особенности установки на crm2.protei.ru


Папку portal, стартовую страницу portal.html и welcome-file в web.xml меняем на crm и crm.html. 













